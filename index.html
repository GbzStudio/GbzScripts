<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot Teste — Gemini 2.5 Flash (local)</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f6f7fb; margin:0; height:100vh; display:flex; align-items:center; justify-content:center; }
    .container { width:100%; max-width:900px; background:white; border-radius:12px; box-shadow:0 6px 30px rgba(20,20,40,0.08); padding:20px; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
    header h1 { font-size:18px; margin:0; }
    #chat { height:58vh; overflow:auto; border:1px solid #eef0f6; padding:12px; border-radius:8px; background:#fcfdff; }
    .msg { margin-bottom:12px; }
    .msg.user { text-align:right; }
    .bubble { display:inline-block; padding:10px 14px; border-radius:12px; max-width:78%; }
    .bubble.user { background:#0b84ff; color:white; border-bottom-right-radius:4px; }
    .bubble.bot { background:#f1f5ff; color:#02102a; border-bottom-left-radius:4px; }
    form { display:flex; gap:8px; margin-top:12px; }
    input[type="text"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e6e9f2; font-size:14px; }
    button { padding:10px 14px; border-radius:8px; border:0; background:#0b84ff; color:white; cursor:pointer; }
    small.info { color:#6b7280; }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="#0b84ff"/></svg>
      <div>
        <h1>Chatbot de Teste — Gemini 2.5 Flash</h1>
        <small class="info">Conectado ao servidor local. (API key fica apenas no servidor.)</small>
      </div>
    </header>

    <div id="chat" aria-live="polite"></div>

    <form id="form">
      <input id="input" type="text" placeholder="Digite sua mensagem..." autocomplete="off" required />
      <button type="submit">Enviar</button>
    </form>
  </div>

<script>
const chatEl = document.getElementById('chat');
const form = document.getElementById('form');
const input = document.getElementById('input');

function appendMessage(text, who='bot') {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (who==='user' ? 'user' : 'bot');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (who==='user' ? 'user' : 'bot');
  bubble.textContent = text;
  wrapper.appendChild(bubble);
  chatEl.appendChild(wrapper);
  chatEl.scrollTop = chatEl.scrollHeight;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  appendMessage(text, 'user');
  input.value = '';
  appendMessage('Pensando...', 'bot'); // placeholder enquanto aguarda

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });
    if(!res.ok) {
      const errText = await res.text();
      // remove o 'Pensando...' anterior
      const last = chatEl.querySelector('.msg.bot:last-child .bubble');
      if (last && last.textContent === 'Pensando...') last.textContent = 'Erro: ' + res.status;
      appendMessage('Detalhes: ' + errText, 'bot');
      return;
    }
    const data = await res.json();
    // espera que o servidor envie { reply: "texto do bot" }
    // substitui o 'Pensando...' pela resposta real
    const last = chatEl.querySelector('.msg.bot:last-child .bubble');
    if (last && last.textContent === 'Pensando...') last.textContent = data.reply || '[sem resposta]';
    else appendMessage(data.reply || '[sem resposta]', 'bot');
  } catch (err) {
    const last = chatEl.querySelector('.msg.bot:last-child .bubble');
    if (last && last.textContent === 'Pensando...') last.textContent = 'Erro de conexão';
    appendMessage(String(err), 'bot');
  }
});
</script>
</body>
</html>