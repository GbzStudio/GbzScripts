<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GbzScripts ‚Äî Rede de Shorts (Instagram UI)</title>
<meta name="description" content="GbzScripts ‚Äî rede social de scripts e shorts, estilo Instagram + Shorts. Autentica√ß√£o, upload, feed, perfis e search.">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fafafa;--card:#ffffff;--muted:#8e8e8e;--accent:#0095f6;--text:#111;
    --ig-grad1:#f58529;--ig-grad2:#dd2a7b;--ig-grad3:#8134af;--ig-grad4:#515bd4;
    --like:#ff2d55;
  }
  @media (prefers-color-scheme: dark){
    :root{--bg:#050607;--card:#0f1113;--muted:#9aa3b2;--text:#e6eef8}
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:var(--text);background:linear-gradient(180deg, var(--bg) 0%, #f3f3f3 100%);-webkit-font-smoothing:antialiased}
  @media (prefers-color-scheme: dark){ body{background:linear-gradient(180deg,#050607 0%, #0b0c10 100%);} }

  /* App centered grid */
  .container{max-width:1100px;margin:16px auto;display:grid;grid-template-columns:1fr 340px;gap:18px;align-items:start;padding:0 12px}
  @media (max-width:980px){ .container{grid-template-columns:1fr;padding-bottom:90px} .sidebar{display:none} }

  /* Top bar */
  .topbar{grid-column:1 / -1;display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--ig-grad1),var(--ig-grad2),var(--ig-grad3),var(--ig-grad4));display:flex;align-items:center;justify-content:center;color:white;font-weight:900}
  .search input{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);width:420px;max-width:360px}

  /* Feed */
  .feed{display:flex;flex-direction:column;gap:18px}
  .card{background:var(--card);border-radius:14px;border:1px solid rgba(0,0,0,0.04);overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,0.03)}
  .short{position:relative;background:#000;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start}
  .short video{width:100%;height:560px;object-fit:cover;background:#000}
  @media (max-width:980px){ .short video{height:72vh} }

  .short-meta{display:flex;gap:12px;padding:12px;align-items:flex-start}
  .avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--ig-grad2),var(--ig-grad4));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  .meta-info{flex:1}
  .meta-info .user{font-weight:800}
  .meta-info .desc{color:var(--muted);font-size:14px;margin-top:6px}
  .actions{display:flex;flex-direction:column;gap:8px;align-items:center}
  .icon-btn{border:none;background:transparent;cursor:pointer;font-size:20px;padding:6px;border-radius:8px;color:inherit}
  .count{font-size:12px;color:var(--muted);margin-top:6px}
  .liked{color:var(--like)}

  /* Sidebar */
  .sidebar{position:sticky;top:18px;display:flex;flex-direction:column;gap:12px}
  .profile-mini{display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:12px}
  .profile-mini .name{font-weight:800}
  .suggestions{padding:12px;background:var(--card);border-radius:12px}
  .suggest-item{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}

  /* Modal */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{background:var(--card);padding:18px;border-radius:12px;width:92%;max-width:560px;border:1px solid rgba(0,0,0,0.06)}
  .modal h3{margin:0 0 8px 0}
  .input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;margin-top:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--ig-grad3),var(--ig-grad4));color:white}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:inherit}

  /* Comments */
  .comments{padding:12px;border-top:1px solid rgba(0,0,0,0.03)}
  .comment{display:flex;gap:8px;margin-bottom:8px}
  .c-avatar{width:34px;height:34px;border-radius:50%;background:#cbd5e1}
  .c-body{flex:1}

  /* mobile bottom nav */
  .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;width:420px;max-width:92%;display:none;background:var(--card);padding:8px;border-radius:999px;justify-content:space-around;box-shadow:0 8px 30px rgba(0,0,0,0.2)}
  .bottom-nav button{background:transparent;border:none;font-size:20px}
  @media (max-width:980px){ .bottom-nav{display:flex} .container{grid-template-columns:1fr} .sidebar{display:none} }
  .muted{color:var(--muted)}
  .center{text-align:center}
  .hidden{display:none}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar" style="margin:12px auto;max-width:1100px;padding:12px;">
  <div class="brand">
    <div class="logo">Gbz</div>
    <div style="display:flex;flex-direction:column">
      <div style="font-weight:900">GbzScripts</div>
      <div class="muted" style="font-size:12px">Rede de scripts & shorts</div>
    </div>
  </div>

  <div style="display:flex;gap:10px;align-items:center">
    <div class="search"><input id="globalSearch" placeholder="Pesquisar: v√≠deos, usu√°rios, scripts..." /></div>
    <button id="uploadBtn" class="btn btn-primary">Enviar</button>
    <button id="authBtn" class="btn btn-ghost">Entrar</button>
  </div>
</div>

<!-- App grid -->
<div class="container" style="max-width:1100px;margin-top:18px;">

  <!-- FEED -->
  <div class="feed" id="feedColumn">
    <!-- feed items injected by JS -->
  </div>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="profile-mini card">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--ig-grad2),var(--ig-grad4));display:flex;align-items:center;justify-content:center;color:white;font-weight:800" id="miniAvatar">G</div>
        <div>
          <div class="name" id="miniName">Convidado</div>
          <div class="muted" id="miniHandle">@convidado</div>
        </div>
      </div>
    </div>

    <div class="suggestions card">
      <h4 style="margin:0 0 8px 0">Sugest√µes</h4>
      <div id="suggestList"></div>
    </div>

    <div class="suggestions card">
      <h4 style="margin:0 0 8px 0">Trending</h4>
      <div id="trendingList" class="muted">‚Äî</div>
    </div>
  </aside>
</div>

<!-- Upload Modal -->
<div class="modal-bg" id="uploadModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Enviar Short (v√≠deo)</h3>
    <div class="muted">Recomendado MP4 ‚Äî dura√ß√£o at√© 60s (configur√°vel).</div>
    <input id="videoFile" type="file" accept="video/*" />
    <input id="videoTitle" class="input" placeholder="T√≠tulo do short" />
    <textarea id="videoDesc" class="input" placeholder="Descri√ß√£o (opcional)"></textarea>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeUpload()">Cancelar</button>
      <button class="btn btn-primary" onclick="submitUpload()">Enviar</button>
    </div>
    <div id="uploadProgress" class="muted" style="margin-top:8px"></div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal-bg" id="loginModal">
  <div class="modal">
    <h3>Entrar / Registrar</h3>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="authEmail" class="input" placeholder="email@exemplo.com" />
      <input id="authPassword" class="input" placeholder="Senha" type="password" />
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeLogin()">Fechar</button>
      <button class="btn btn-primary" onclick="handleRegister()">Registrar</button>
      <button class="btn btn-primary" onclick="handleSignIn()">Entrar</button>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center"><button class="btn btn-ghost" onclick="signInWithGoogle()">Entrar com Google</button><div class="muted">OAuth via Firebase</div></div>
    <div class="muted" style="margin-top:10px">Deriva√ß√£o de senha com scrypt aqui √© demonstrativa; recomenda-se backend em produ√ß√£o.</div>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal-bg" id="profileModal">
  <div class="modal" style="max-width:720px">
    <div style="display:flex;gap:12px;align-items:center">
      <div id="profileAvatar" style="width:88px;height:88px;border-radius:50%;background:linear-gradient(135deg,#ff9a3c,#d6287b);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:28px">G</div>
      <div>
        <div style="font-weight:800" id="profileName">Convidado</div>
        <div class="muted" id="profileHandle">@convidado</div>
      </div>
      <div style="margin-left:auto"><button class="btn btn-primary" onclick="editProfile()">Editar</button></div>
    </div>
    <div style="margin-top:12px" id="profileStats" class="muted">‚Äî</div>
    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(0,0,0,0.06)">
    <div id="profileContent"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeProfile()">Fechar</button></div>
  </div>
</div>

<!-- bottom nav for mobile -->
<div class="bottom-nav" id="mobileNav">
  <button onclick="scrollTop()">üè†</button>
  <button onclick="openUpload()">‚ûï</button>
  <button onclick="openProfile()">üë§</button>
</div>

<!-- toast -->
<div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 12px;border-radius:999px;display:none;z-index:3000"></div>

<!-- ========================
     CONFIG & LIBS
     ======================== -->

<script>
/* === your security/hash config (as provided) === */
const hash_config = {
  algorithm: 'SCRYPT',
  base64_signer_key: 'rvFvAj6xFNxBOTzmbjuk4FdDz5btzfPFIVNYdotfY7moes/lEFzF35stNcDwCxkuRy+mlem5rTfm5e+DgsGy7A==',
  base64_salt_separator: 'Bw==',
  rounds: 8,
  mem_cost: 14
};

/* === Google client id provided by you === */
const GOOGLE_CLIENT_ID = '873308453565-kccd4pmdru85pp0iiii9n807o72rnr64.apps.googleusercontent.com';

/* === Firebase config (provided) ===
   If you want to replace, change below object
*/
const firebaseConfig = {
  apiKey: "AIzaSyALpPt-tUWB0Gq-UeJXOJRRkyt0si8s4Nc",
  authDomain: "fir-auth-3521c.firebaseapp.com",
  databaseURL: "https://fir-auth-3521c-default-rtdb.firebaseio.com",
  projectId: "fir-auth-3521c",
  storageBucket: "fir-auth-3521c.firebasestorage.app",
  messagingSenderId: "873308453565",
  appId: "1:873308453565:web:4ff8d9863adb1eae1c95d4",
  measurementId: "G-LWMZJ55W7N"
};

/* load scrypt + firebase compat libs dynamically to keep file single */
(function loadLibs(){
  const libs = [
    "https://cdn.jsdelivr.net/npm/scrypt-js@3.0.1/scrypt.min.js",
    "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js",
    "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js",
    "https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js",
    "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"
  ];
  libs.forEach(src=>{
    const s = document.createElement('script'); s.src = src; document.head.appendChild(s);
  });
})();
</script>

<!-- ========================
     MAIN APP LOGIC (single-file)
     ======================== -->
<script>
/* Utilities */
const Util = (function(){
  function toast(msg, ms=3000){ const el = document.getElementById('toast'); el.textContent = msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none', ms); }
  function log(...a){ try{ console.log(...a); }catch(e){} }
  function debounce(fn,ms=300){ let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms); } }
  function uuid(){ return 'id-'+Math.random().toString(36).slice(2,10); }
  return {toast,log,debounce,uuid};
})();

/* Wait for firebase libs to be ready, init */
function waitForFirebase(cb, timeout=10000){
  const start = Date.now();
  (function check(){
    if(window.firebase && firebase.initializeApp){
      try{ firebase.initializeApp(firebaseConfig); window._auth = firebase.auth(); window._db = firebase.database(); window._storage = firebase.storage(); cb(null); return; }catch(e){ cb(e); return; }
    }
    if(Date.now()-start > timeout){ cb(new Error('timeout')); return; }
    setTimeout(check,150);
  })();
}

/* Anti-bug handlers */
window.addEventListener('error', e => { localStorage.setItem('__gbz_last_error', JSON.stringify({message:e.message,file:e.filename,line:e.lineno,stack:e.error?e.error.stack:null,ts:Date.now()})); });
window.addEventListener('unhandledrejection', e => { console.error('UnhandledRejection', e); });

/* App state */
let STATE = { user:null, shorts:[], users:{}, follows:{} };

/* DOM refs */
const feedColumn = document.getElementById('feedColumn');
const uploadModal = document.getElementById('uploadModal');
const loginModal = document.getElementById('loginModal');
const profileModal = document.getElementById('profileModal');
const uploadBtn = document.getElementById('uploadBtn');
const authBtn = document.getElementById('authBtn');
const globalSearch = document.getElementById('globalSearch');

/* actions bindings */
uploadBtn.addEventListener('click', ()=> { if(!STATE.user) openLogin(); else openUpload(); });
authBtn.addEventListener('click', ()=> { if(!STATE.user) openLogin(); else signOut(); });
globalSearch.addEventListener('input', Util.debounce(e=>searchAll(e.target.value), 300));

/* Scrypt derive helper (client-side) */
async function derivePasswordKey(password, saltBase64=null){
  if(!window.scrypt) throw new Error('scrypt-js not loaded');
  const pw = new TextEncoder().encode(password);
  let salt;
  if(saltBase64){
    const bin = atob(saltBase64); salt = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) salt[i]=bin.charCodeAt(i);
  } else {
    salt = crypto.getRandomValues(new Uint8Array(16));
  }
  const N = Math.pow(2, Math.max(1, hash_config.mem_cost || 14)); // mem_cost -> 14 => 16384
  const r = 8; const p = Math.max(1, hash_config.rounds || 1); const dkLen = 64;
  return await new Promise((resolve,reject)=> {
    scrypt(pw, salt, N, r, p, dkLen, function(err, progress, key){
      if(err) return reject(err);
      if(key){
        const b64 = btoa(String.fromCharCode.apply(null, Array.from(key)));
        const saltB64 = btoa(String.fromCharCode.apply(null, Array.from(salt)));
        resolve({derivedKeyBase64: b64, saltBase64: saltB64});
      }
    });
  });
}

/* AUTH flows */
async function handleRegister(){
  try{
    const email = (document.getElementById('authEmail').value||'').trim();
    const password = (document.getElementById('authPassword').value||'');
    if(!email||!password) return Util.toast('Preencha email e senha');
    const {derivedKeyBase64, saltBase64} = await derivePasswordKey(password);
    await _auth.createUserWithEmailAndPassword(email, derivedKeyBase64);
    const uid = _auth.currentUser.uid;
    await _db.ref('users/'+uid).set({email, displayName: email.split('@')[0], createdAt:Date.now(), salt: saltBase64});
    Util.toast('Conta criada');
    closeLogin();
  }catch(err){ Util.log('registerErr', err); Util.toast('Erro ao registrar: '+(err.message||err)); }
}

async function handleSignIn(){
  try{
    const email = (document.getElementById('authEmail').value||'').trim();
    const password = (document.getElementById('authPassword').value||'');
    if(!email||!password) return Util.toast('Preencha email e senha');
    const snap = await _db.ref('users').orderByChild('email').equalTo(email).once('value');
    let salt = null; snap.forEach(c=>{ const v=c.val(); if(v && v.salt) salt=v.salt; });
    if(!salt) return Util.toast('Conta n√£o encontrada');
    const {derivedKeyBase64} = await derivePasswordKey(password, salt);
    await _auth.signInWithEmailAndPassword(email, derivedKeyBase64);
    Util.toast('Bem-vindo');
    closeLogin();
  }catch(err){ Util.log('signinErr', err); Util.toast('Erro ao logar: '+(err.message||err)); }
}

async function signInWithGoogle(){
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await _auth.signInWithPopup(provider);
    Util.toast('Logado com Google');
    closeLogin();
  }catch(err){ Util.log('googleErr', err); Util.toast('Erro Google: '+(err.message||err)); }
}

function signOut(){ if(!_auth) return; _auth.signOut().then(()=>{ Util.toast('Desconectado'); }).catch(e=>Util.log('signout', e)); }

/* Auth state binding */
function bindAuthState(){
  _auth.onAuthStateChanged(async user=>{
    STATE.user = user;
    updateTopUI();
    if(user){
      // ensure DB user record exists
      const uref = _db.ref('users/'+user.uid);
      const s = await uref.once('value');
      if(!s.exists()){
        await uref.set({email:user.email||null, displayName:user.displayName||user.email.split('@')[0], createdAt:Date.now()});
      }
      loadProfileData(user.uid);
    } else {
      // guest
    }
  });
}

/* UI updates */
function updateTopUI(){
  if(STATE.user){
    authBtn.textContent = 'Sair';
    document.getElementById('miniName').textContent = STATE.user.displayName || (STATE.user.email?STATE.user.email.split('@')[0]:'User');
    document.getElementById('miniHandle').textContent = '@' + (STATE.user.displayName || (STATE.user.email?STATE.user.email.split('@')[0]:'user'));
  } else {
    authBtn.textContent = 'Entrar';
    document.getElementById('miniName').textContent = 'Convidado';
    document.getElementById('miniHandle').textContent = '@convidado';
  }
}

/* Upload logic */
function openUpload(){ uploadModal.style.display='flex'; }
function closeUpload(){ uploadModal.style.display='none'; document.getElementById('videoFile').value=''; document.getElementById('videoTitle').value=''; document.getElementById('videoDesc').value=''; document.getElementById('uploadProgress').textContent=''; }
function openLogin(){ loginModal.style.display='flex'; }
function closeLogin(){ loginModal.style.display='none'; }
function openProfile(){ profileModal.style.display='flex'; }
function closeProfile(){ profileModal.style.display='none'; }

async function submitUpload(){
  try{
    if(!STATE.user){ openLogin(); return; }
    const fileInput = document.getElementById('videoFile');
    const title = (document.getElementById('videoTitle').value||'').trim();
    const desc = (document.getElementById('videoDesc').value||'').trim();
    if(!fileInput.files.length) return Util.toast('Selecione um arquivo de v√≠deo');
    if(!title) return Util.toast('Informe um t√≠tulo');
    const file = fileInput.files[0];
    const id = Util.uuid();
    const path = `shorts/${STATE.user.uid}/${id}_${file.name}`;
    const storageRef = _storage.ref().child(path);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed', snap=>{
      const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      document.getElementById('uploadProgress').textContent = `Enviando: ${pct}%`;
    }, err=>{
      Util.log('uploadErr', err); Util.toast('Erro no upload: '+err.message);
    }, async ()=>{
      const url = await storageRef.getDownloadURL();
      const meta = { id, title, desc, owner: STATE.user.uid, ownerName: STATE.user.displayName||STATE.user.email.split('@')[0], url, createdAt: Date.now(), likes:0, comments:0 };
      await _db.ref('shorts/'+id).set(meta);
      await _db.ref(`user_shorts/${STATE.user.uid}/${id}`).set(true);
      Util.toast('Upload conclu√≠do');
      closeUpload();
      loadShorts();
      loadProfileData(STATE.user.uid);
    });
  }catch(e){ Util.log('submitUploadErr', e); Util.toast('Erro ao enviar: ' + (e.message||e)); }
}

/* Load shorts into STATE and render feed */
async function loadShorts(){
  try{
    const snap = await _db.ref('shorts').orderByChild('createdAt').limitToFirst(200).once('value');
    const val = snap.val() || {};
    const arr = Object.keys(val).map(k=>val[k]).sort((a,b)=>b.createdAt - a.createdAt);
    STATE.shorts = arr;
    renderFeed(arr);
    // trending
    const trending = arr.slice().sort((a,b)=> (b.likes||0)-(a.likes||0)).slice(0,6);
    document.getElementById('trendingList').innerHTML = trending.map(t=>`<div style="margin-bottom:8px"><strong>${escapeHtml(t.title)}</strong><div class="muted">by ${escapeHtml(t.ownerName||'‚Äî')}</div></div>`).join('');
  }catch(e){ Util.log('loadShorts', e); }
}

/* Render feed */
function renderFeed(list){
  feedColumn.innerHTML = '';
  if(!list.length) feedColumn.innerHTML = `<div class="card center" style="padding:28px">Sem shorts ‚Äî seja o primeiro a enviar!</div>`;
  list.forEach(item=>{
    const card = document.createElement('div'); card.className='card';
    const short = document.createElement('div'); short.className='short';
    // video element
    const vid = document.createElement('video'); vid.src = item.url; vid.controls=false; vid.muted=true; vid.loop=true; vid.playsInline=true; vid.preload='metadata';
    vid.addEventListener('click', ()=> { if(vid.paused) vid.play(); else vid.pause(); });
    // meta area
    const meta = document.createElement('div'); meta.className='short-meta';
    meta.innerHTML = `<div class="avatar">${(item.ownerName||'U').charAt(0).toUpperCase()}</div>
      <div class="meta-info">
        <div class="user">${escapeHtml(item.ownerName||'‚Äî')} <span class="muted"> ‚Ä¢ ${timeAgo(item.createdAt)}</span></div>
        <div class="desc">${escapeHtml(item.title)}</div>
      </div>
      <div class="actions">
        <button class="icon-btn like-btn" title="Curtir" onclick="toggleLike('${item.id}', this)">${item._liked? '‚ù§Ô∏è' : 'ü§ç'}</button>
        <div class="count" id="likecount-${item.id}">${item.likes||0}</div>
        <button class="icon-btn" title="Coment√°rios" onclick="openComments('${item.id}')">üí¨</button>
        <button class="icon-btn" title="Ver perfil" onclick="openProfileById('${item.owner}')">üë§</button>
      </div>`;
    // comments
    const comments = document.createElement('div'); comments.className='comments hidden'; comments.id = 'comments-'+item.id;
    comments.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Coment√°rios</div><div id="commentsList-${item.id}"></div>
      <div style="display:flex;gap:8px;margin-top:8px"><input placeholder="Escreva um coment√°rio..." id="cinput-${item.id}" class="input" /><button class="btn btn-primary" onclick="postComment('${item.id}')">Enviar</button></div>`;
    short.appendChild(vid); short.appendChild(meta); short.appendChild(comments);
    card.appendChild(short); feedColumn.appendChild(card);
    observeVideo(vid);
  });
}

/* IntersectionObserver for autoplay/pause */
function observeVideo(vid){
  const io = new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){ vid.play().catch(()=>{}); }
      else vid.pause();
    });
  }, {threshold:0.6});
  io.observe(vid);
}

/* Likes/comments/follow */
async function toggleLike(shortId, el){
  if(!STATE.user){ openLogin(); return; }
  try{
    const likeRef = _db.ref(`short_likes/${shortId}/${STATE.user.uid}`);
    const snap = await likeRef.once('value');
    if(snap.exists()){
      await likeRef.remove();
      await _db.ref(`shorts/${shortId}/likes`).transaction(l=> (l||0)-1 );
      Util.toast('Like removido');
    } else {
      await likeRef.set(true);
      await _db.ref(`shorts/${shortId}/likes`).transaction(l=> (l||0)+1 );
      Util.toast('Voc√™ curtiu');
    }
    loadShorts();
  }catch(e){ Util.log('toggleLike', e); }
}

async function postComment(shortId){
  if(!STATE.user){ openLogin(); return; }
  const input = document.getElementById('cinput-'+shortId); const text = (input.value||'').trim();
  if(!text) return;
  const id = Util.uuid();
  const payload = {id, author: STATE.user.uid, authorName:STATE.user.displayName||STATE.user.email.split('@')[0], text, ts:Date.now()};
  await _db.ref(`short_comments/${shortId}/${id}`).set(payload);
  await _db.ref(`shorts/${shortId}/comments`).transaction(c=> (c||0)+1 );
  input.value='';
  loadComments(shortId);
}

async function loadComments(shortId){
  const listEl = document.getElementById('commentsList-'+shortId);
  const snap = await _db.ref(`short_comments/${shortId}`).orderByChild('ts').once('value');
  const val = snap.val() || {};
  const arr = Object.keys(val).map(k=>val[k]).sort((a,b)=>a.ts-b.ts);
  listEl.innerHTML = arr.map(c=>`<div class="comment"><div class="c-avatar"></div><div class="c-body"><div style="font-weight:700">${escapeHtml(c.authorName||'‚Äî')}</div><div class="muted">${escapeHtml(c.text)}</div></div></div>`).join('');
}

/* Profile and users */
async function openProfileById(uid){
  if(!uid) return Util.toast('Usu√°rio inv√°lido');
  await loadProfileData(uid, true);
}
function openProfile(){ profileModal.style.display='flex'; }
function closeProfile(){ profileModal.style.display='none'; }

async function loadProfileData(uid, show=false){
  try{
    const snap = await _db.ref('users/'+uid).once('value');
    const v = snap.val() || {};
    document.getElementById('profileName').textContent = v.displayName || (v.email? v.email.split('@')[0] : 'Usu√°rio');
    document.getElementById('profileHandle').textContent = '@'+(v.displayName || (v.email? v.email.split('@')[0] : 'user'));
    document.getElementById('profileAvatar').textContent = (v.displayName || (v.email? v.email.split('@')[0] : 'U')).charAt(0).toUpperCase();
    const shortsSnap = await _db.ref(`user_shorts/${uid}`).once('value');
    const shortsCount = shortsSnap.exists() ? Object.keys(shortsSnap.val()).length : 0;
    const followersSnap = await _db.ref(`followers/${uid}`).once('value');
    const followers = followersSnap.exists()? Object.keys(followersSnap.val()).length : 0;
    document.getElementById('profileStats').textContent = `${shortsCount} shorts ‚Ä¢ ${followers} seguidores`;
    const shortsList = [];
    if(shortsSnap.exists()){
      for(const id of Object.keys(shortsSnap.val())){
        const s = (await _db.ref('shorts/'+id).once('value')).val();
        if(s) shortsList.push(s);
      }
    }
    document.getElementById('profileContent').innerHTML = shortsList.length ? shortsList.map(s=>`<div style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.03);margin-bottom:8px"><strong>${escapeHtml(s.title)}</strong><div class="muted">Publicado: ${new Date(s.createdAt).toLocaleString()}</div></div>`).join('') : '<div class="muted">Nenhum short.</div>';
    if(show) openProfile();
  }catch(e){ Util.log('profileErr', e); }
}

/* Follow/unfollow (simple) */
async function toggleFollow(targetUid){
  if(!STATE.user){ openLogin(); return; }
  const me = STATE.user.uid;
  const path = `followers/${targetUid}/${me}`;
  const snap = await _db.ref(path).once('value');
  if(snap.exists()){ await _db.ref(path).remove(); Util.toast('Deixou de seguir'); } else { await _db.ref(path).set(true); Util.toast('Seguindo'); }
}

/* Search logic: videos by title or users by name/email */
async function searchAll(qRaw){
  const q = (qRaw||'').trim().toLowerCase();
  if(!q){ loadShorts(); return; }
  // search shorts
  const sSnap = await _db.ref('shorts').once('value'); const sVal = sSnap.val() || {};
  const sArr = Object.keys(sVal).map(k=>sVal[k]).filter(s => (s.title||'').toLowerCase().includes(q) || (s.ownerName||'').toLowerCase().includes(q));
  if(sArr.length){ renderFeed(sArr); return; }
  // otherwise search users
  const uSnap = await _db.ref('users').once('value'); const uVal = uSnap.val() || {};
  const uArr = Object.keys(uVal).map(k=>({uid:k,...uVal[k]})).filter(u => (u.displayName||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
  if(uArr.length){
    feedColumn.innerHTML = `<div class="card" style="padding:18px"><h3>Resultados - usu√°rios</h3>${uArr.map(u=>`<div style="display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;margin-top:8px"><div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#ff9a3c,#d6287b);display:flex;align-items:center;justify-content:center">${(u.displayName||u.email||'U').charAt(0).toUpperCase()}</div><div><div style="font-weight:700">${escapeHtml(u.displayName||u.email)}</div><div class="muted">@${(u.displayName||u.email).split('@')[0]}</div></div><div style="margin-left:auto"><button class="btn btn-primary" onclick="openProfileById('${u.uid}')">Ver perfil</button></div></div>`).join('')}</div>`;
    return;
  }
  feedColumn.innerHTML = `<div class="card center" style="padding:28px">Nenhum resultado para "<strong>${escapeHtml(q)}</strong>"</div>`;
}

/* Comments open/close */
async function openComments(shortId){
  const el = document.getElementById('comments-'+shortId);
  if(!el) return;
  el.classList.toggle('hidden');
  if(!el.classList.contains('hidden')) await loadComments(shortId);
}

/* Load comments */
async function loadComments(shortId){
  const listEl = document.getElementById('commentsList-'+shortId);
  const snap = await _db.ref(`short_comments/${shortId}`).orderByChild('ts').once('value');
  const val = snap.val() || {};
  const arr = Object.keys(val).map(k=>val[k]).sort((a,b)=>a.ts-b.ts);
  listEl.innerHTML = arr.map(c=>`<div class="comment"><div class="c-avatar"></div><div class="c-body"><div style="font-weight:700">${escapeHtml(c.authorName||'‚Äî')}</div><div class="muted">${escapeHtml(c.text)}</div></div></div>`).join('');
}

/* Helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
function timeAgo(ts){ if(!ts) return ''; const s = Math.floor((Date.now()-ts)/1000); if(s<60) return `${s}s`; if(s<3600) return `${Math.floor(s/60)}m`; if(s<86400) return `${Math.floor(s/3600)}h`; return `${Math.floor(s/86400)}d`; }
function scrollTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

/* Init: wait for firebase libs, then bind */
waitForFirebase((err)=>{
  if(err){
    Util.log('firebase init failed', err);
    Util.toast('Firebase n√£o inicializado; backend desativado (algumas fun√ß√µes requerem Firebase).');
    // UI will still render but DB functions will error if used.
    return;
  }
  bindAuthState();
  loadShorts();
  loadSuggestions();
  // live updates
  _db.ref('shorts').on('value', ()=> loadShorts());
});

/* Suggestions loader */
async function loadSuggestions(){
  try{
    const snap = await _db.ref('users').limitToFirst(8).once('value'); const val = snap.val()||{};
    const arr = Object.keys(val).map(k=>({uid:k,...val[k]}));
    const sl = document.getElementById('suggestList');
    sl.innerHTML = arr.map(u=>`<div class="suggest-item"><div style="display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#ff9a3c,#d6287b);display:flex;align-items:center;justify-content:center">${(u.displayName||u.email||'U').charAt(0).toUpperCase()}</div><div><div style="font-weight:700">${escapeHtml(u.displayName||u.email)}</div><div class="muted">@${(u.displayName||u.email||'user').split('@')[0]}</div></div></div><div><button class="btn btn-primary" onclick="openProfileById('${u.uid}')">Ver</button></div></div>`).join('');
  }catch(e){ Util.log('suggestions err', e); }
}

/* open login modal helpers exposed for inline handlers */
window.handleRegister = handleRegister;
window.handleSignIn = handleSignIn;
window.signInWithGoogle = signInWithGoogle;
window.openUpload = openUpload;
window.closeUpload = closeUpload;
window.openLogin = openLogin;
window.closeLogin = closeLogin;
window.openProfile = openProfile;
window.closeProfile = closeProfile;
window.submitUpload = submitUpload;
window.openProfileById = openProfileById;
window.postComment = postComment;
window.scrollTop = scrollTop;
window.toggleLike = toggleLike;
window.openComments = openComments;
window.openProfileById = openProfileById;
window.toggleFollow = toggleFollow;

/* Expose simple signOut */
window.signOut = signOut;

/* small convenience: open profile by id (used in search results) */
async function openProfileById(uid){ await loadProfileData(uid, true); }

/* openUpload when top button clicked */
document.getElementById('uploadBtn').addEventListener('click', ()=> { if(!STATE.user) openLogin(); else openUpload(); });
document.getElementById('authBtn').addEventListener('click', ()=> { if(!STATE.user) openLogin(); else signOut(); });

</script>
</body>
</html>
